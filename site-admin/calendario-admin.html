<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Casa do Cão</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="../estilo.css">
  <style>
    .cell{
      text-align: center;
      vertical-align: middle;
      width: 35px;
      height: 60px;
      padding: 0;
    }
    .cell-text{
      background-color: rgba(187, 148, 105, 0.6);
      text-align: center;
      height: 35px;
      width: 35px;
      border-radius: 50%;
      line-height: 35px;
      display: inline-block;
    }
    td{
      padding:5px;
      text-align: center;
    }
    table{
      border-collapse: collapse ;
    }
    a{
      text-decoration: none;
      color: black;
    }
  </style>
</head>
<body>

<!-- Navbar com o retângulo e a curva -->
<nav class="navbar navbar-expand-lg navbar-fixed">
  <div class="container">
    <a class="navbar-brand" href="#" id="texto-icone"><img src="../recursos/paw-title.png" style="height: 45px;"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse rounded-5" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item" id="nav-services">
          <a class="nav-link" href="adicionar-animal.html">
            Adicionar Animal
          </a>
        </li>
        <li class="nav-item" id="nav-marketplace">
            <a class="nav-link" href="calendário-admin.html">Consultas Marcadas</a>
          </li>
        <li class="nav-item" id="nav-gerir    ">
          <a class="nav-link" href="gerirmarketplace.html" >Gerir Marketplace</a>
        </li>
        <li class="nav-item" id="nav-gerir    ">
          <a class="nav-link" href="gerirdogwalking.html">Gerir Dog-walking</a>
        </li>
        <li class="nav-item" id="nav-about">
          <a class="nav-link" href="#" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDark-Sobre" aria-controls="offcanvasDark">Sobre</a>
        </li>
        <li class="nav-item" id="nav-login">
            <a class="nav-link" href="../login e registo/log_in.html">Entrar</a> 
        </li>
      </ul>
    </div>
  </div>
  <!-- Curva SVG -->
  <svg class="top-curve" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 728.4 77.7">
    <defs>
      <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
        <feDropShadow dx="0" dy="7" stdDeviation="4" flood-color="rgba(0, 0, 0, 0.2)" />
      </filter>
    </defs>
    <path fill="rgb(246, 242, 242)" d="M0 45.3c8.9 1.7 21.6 4 37 6.6C73.7 58.1 103.2 63 140.5 66c27.4 2.1 46.8 3.6 73.5 1.3 10.9-.9 29-2.5 52-8.4 15.1-3.8 16.8-5.6 44.5-14.1 24.7-7.6 37-11.4 49.3-13.7 22.1-4 39.1-3.8 60.8-3.5 23.4.3 41.1 2.3 55.9 4 26 2.9 47.8 6.9 51.1 7.5 18.3 3.3 19.6 4.3 30.8 5.7 4.6.6 22.2 2.6 45.4 1.3 5.7-.3 21.8-1.4 42.3-5.7 7.2-1.5 18.8-4 33.5-9.2 14.6-5.2 25.4-10.7 31.3-13.7 4.4-2.2 10.2-4.3 16.7-9.2 4.1-3.1 7.2-6.1 9.2-8.3H.2L0 45.3z" style="filter: url(#shadow);"></path>
  </svg> 
</nav>
<!-- Menu lateral -->
<div class=" offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="offcanvasDark" aria-labelledby="offcanvasDarkLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasDarkLabel">Vetria</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <p>Escolha o serviço:</p>
      <a href="#home" class="btn btn-dark mb-2 w-100 text-start">Os meus animais</a>
      <a href="#sobre" class="btn btn-dark mb-2 w-100 text-start">Agendamento de Consultas</a>
      <a href="#servicos" class="btn btn-dark mb-2 w-100 text-start">Dog-walking</a>
    </div>
</div>
    <!--Menu Lateral User-->
    <div class="offcanvas offcanvas-start text-bg-dark" id="offcanvasDark-User" tabindex="-1" aria-labelledby="offcanvasDarkLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasDarkLabel">Utilizador</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <a style="text-decoration: none;" calss='btn' onclick="log_out();">Log Out</a>
      </div>
    </div>

<!--Calendário-->
<div class="container" style="padding-top: 200px;">
  <h1 class="h1 text-center mb-3" id="month_h1"></h1>
  <div class="row">
    <div class="col-1" id="backward_btn"><i class='fa fa-backward' onclick="month_backward()"></i></div>
    <table class="col-3" style="width: 800px; height: 300px; margin-left: auto; margin-right: auto;" id='calendar_container'></table>
    <div class="col-1 id="forward_btn"><i class='fa fa-forward' onclick="month_forward()"></i></div>
  </div>
</div>

<!--Modal que aparece quando se carrega num dia com evento-->
<div class="modal" id="modal" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-title"></h5>
        <button type="button" class="close" data-bs-dismiss="modal" aria-label="close">
          <span aria-hidden="true">&times;</span>
      </div>
      <div class="modal-body" id="modal_body"></div>
      <button type="button" class="btn btn-primary" style="margin-left: 20px; margin-right: 20px; margin-bottom: 20px;" onclick="desmarcar()" data-bs-dismiss="modal">Desmarcar</button>
      <!--Botão desmarcar: Remove da BD o evento-->
    </div>
  </div>
</div>

<!--Botão para adicionar evento-->
<!--Não deverá mostrar horas onde outros têm consultas-->

<svg class="bottom-curve" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 728.4 77.7" style="position: absolute; bottom: -2px; left: 0; width: 100%; z-index: 1;">
  <path fill="rgb(246, 242, 242)"  d="M0 37.5c8.1-4.6 15.1-7.9 20.3-10.1 10.3-4.4 18.5-6.8 28.2-9.7 5-1.5 11.3-3.3 19.8-5.3C74.4 11 85 8.6 99.1 7.1c11.2-1.2 19.7-1.3 24.7-1.3 13.8-.1 24.5.8 29.5 1.3 10.6 1.1 18.6 2.5 21.6 3.1 5.3 1 5.9 1.3 23.3 5.3 10.1 2.3 15.2 3.5 19.8 4.4 6.2 1.2 10.8 2 19.8 3.5 6.1 1 13.1 2.2 22.5 3.5 8.1 1.2 14.4 1.9 16.7 2.2 6 .7 15 1.8 26 2.6 10 .8 16.9 1.3 26 1.3 17.2 0 30.6-1.9 35.7-2.6 10.3-1.6 17.4-3.4 31.3-7 14.4-3.7 15.1-4.5 32.6-9.2 11-3 19.2-5.2 30.4-7.5 7.5-1.5 16.6-3.4 28.6-4.8 16.4-2 29.2-2 39.5-1.9 13.7.1 24.2 1 34.3 1.8 11 .9 19.2 1.8 26.4 2.6 8 .9 21.6 2.6 38.8 5.3 18.4 2.9 31.8 5.5 46.2 8.4 14.8 2.9 33.6 6.8 55.5 11.9v47.7H0V37.5z"></path>
</svg>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="Scripts/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function (){
    let user = localStorage.getItem('user');
    if(localStorage.user){
      document.getElementById("nav-login").innerHTML = '<a class="nav-link" href="#" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDark-User" aria-controls="offcanvasDark">' + user + '</a>';
      document.getElementById('navbarDropdown').onclick = () => {};
    }else{
      document.getElementById('navbarDropdown').onclick = () => {window.location.href = 'login e registo/log_in.html';}
    }
 });

 function log_out(){
    localStorage.removeItem('user');
    window.location.href = '../login e registo/log_in.html';
  }
</script>
<script>
  const month_names = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  var today = new Date();
  month = today.getMonth();
  year = today.getFullYear();

  function handle_click_add(obj){
    return () => {
      info = [obj.innerHTML, month, year];
      window.top.postMessage(info, '*');
    };
  }

  function days_in_month(month, year){
    return new Date(year, month + 1, 0).getDate();
  }

  function make_calendar_days(month){
    document.getElementById('month_h1').innerHTML = '<h1 class="h1 text-center" id="month_h1">' + month_names[month] + ' ' + year + '</h1>';
    date = 1;

    for(i=0; i < 7; i++){
      row = document.createElement('tr');

      for(k=0; k < 7; k++){
        if(date > days_in_month(month, year)){break;}

        cell = document.createElement('td');
        cell.classList.add('justify-content-center')
        row.appendChild(cell);
        cell.classList.add('cell');
        cell_text = document.createElement('a');
        
        cell.appendChild(cell_text);
        cell_text.innerHTML = String(date);
        cell_text.addEventListener('click', handle_click_add(cell_text));

        if(date === today.getDate() && month === today.getMonth() && year === today.getFullYear()){
          cell_text.classList.add('cell-text');
          cell_text.classList.add('nav-link');
        }
        date++;
      }
      document.getElementById('calendar_container').appendChild(row);
    }
  }

  function get_events(month){
    const events_ = JSON.parse(sessionStorage.getItem('appointments'));
    do_events(events_, month);
  }

  function handleDayClick(eventData) {
  return function () {
    document.getElementById('modal-title').innerHTML = 
      `${eventData.date[0]}/${eventData.date[1]}/${eventData.date[2]}`;
    document.getElementById('modal_body').innerHTML = 
      `${eventData.user} tem uma ${eventData.reason} às ${eventData.time}`;
    $('#modal').modal('toggle');
    info = eventData.date;
    window.top.postMessage(info, '*');
    console.log(info);
    };
  }


  function do_events(events, month){
    console.log(events);
    days_arr = document.getElementsByClassName('cell');
    for(k=0; k < days_arr.length; k++){
      for(i=0; i < events.length; i++){
        if(events[i].date[0] === days_arr[k].firstChild.innerHTML && events[i].date[1] === String(month) && events[i].date[2] === String(year)){
          const eventData = events[i];
          console.log(eventData);
          days_arr[k].firstChild.classList.add('cell-text', 'nav-link');
          
          days_arr[k].firstChild.addEventListener('click', handleDayClick(eventData));
          days_arr[k].firstChild._clickHandler = handleDayClick(eventData);
        }
      }
    }
  }

  function month_backward(){
    month --;
    if(month < 0){
      month = 11;
      year--;
    }
    document.getElementById('calendar_container').innerHTML = '';
    make_calendar_days(month);
    get_events(month);
  }

  function month_forward(){
    month ++;
    if(month > 11){
      month = 0;
      year++;
    }
    document.getElementById('calendar_container').innerHTML = '';
    make_calendar_days(month);
    get_events(month);
  }

  function desmarcar(){
    let appointments = JSON.parse(sessionStorage.getItem('appointments'));
    console.log(appointments);
    var date = document.getElementById('modal-title').innerHTML;
    date_arr = date.split('/');
    remove_day = date_arr[0];
    console.log(document.getElementById('modal_body').innerHTML);
    time = document.getElementById('modal_body').innerHTML.split(' ');
    time = time[time.length - 1];
    console.log(time);

    var calendar_days = document.getElementsByClassName('cell');

    for(k=0; k < calendar_days.length; k++){
      const cellText = calendar_days[k].firstChild;

      if (cellText.innerHTML === remove_day) {
        calendar_days[k].removeChild(cellText);
        cell_ = document.createElement('a');
        cell_.innerHTML = remove_day;
        calendar_days[k].appendChild(cell_);
        calendar_days[k].firstChild.classList.add('justify-content-center', 'cell');

        for(i=0; i < appointments.length; i++){
          if(appointments[i].date[0] === date_arr[0] && appointments[i].date[1] === date_arr[1] && appointments[i].date[2] === date_arr[2] && appointments[i].time === time){
            console.log(appointments);
            appointments.pop(appointments[i]);
            console.log(appointments);
            sessionStorage.setItem('appointments', JSON.stringify(appointments));
          }
        }
      }
    }
  }

  $(document).ready(function (){
    make_calendar_days(month);
    get_events(month);
  });
</script>
</body>
</html>